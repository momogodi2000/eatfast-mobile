# Fastfile for iOS
default_platform(:ios)

platform :ios do
  desc "Setup code signing with Match"
  lane :setup_signing do
    setup_ci if ENV['CI']

    match(
      type: "appstore",
      readonly: is_ci,
      app_identifier: ["com.eatfast.mobile", "com.eatfast.mobile.dev"]
    )
  end

  desc "Build release version"
  lane :build_release do
    setup_signing

    increment_build_number(
      xcodeproj: "Runner.xcodeproj",
      build_number: latest_testflight_build_number + 1
    )

    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          "com.eatfast.mobile" => "match AppStore com.eatfast.mobile"
        }
      }
    )
  end

  desc "Deploy to TestFlight"
  lane :deploy_testflight do
    build_release

    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      groups: ["Internal Testers"],
      changelog: "Bug fixes and performance improvements"
    )

    slack(
      message: "New iOS build deployed to TestFlight!",
      success: true,
      slack_url: ENV["SLACK_WEBHOOK_URL"]
    )
  end

  desc "Deploy to App Store"
  lane :deploy_appstore do
    build_release

    deliver(
      submit_for_review: true,
      automatic_release: false,
      force: true,
      skip_metadata: false,
      skip_screenshots: false,
      phased_release: true, # Phased release over 7 days
      submission_information: {
        add_id_info_uses_idfa: false
      }
    )

    slack(
      message: "New iOS build submitted to App Store for review!",
      success: true,
      slack_url: ENV["SLACK_WEBHOOK_URL"]
    )
  end

  desc "Build development version"
  lane :build_dev do
    match(type: "development", readonly: is_ci)

    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "dev",
      export_method: "development"
    )

    # Note: Firebase App Distribution removed as per requirements
    # Upload to alternative distribution service if needed
  end

  desc "Run all tests"
  lane :test do
    run_tests(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      devices: ["iPhone 14 Pro"],
      code_coverage: true
    )
  end

  desc "Screenshot generation"
  lane :screenshots do
    capture_screenshots
    frameit
  end

  desc "Sync certificates and profiles"
  lane :sync_code_signing do
    match(type: "development")
    match(type: "appstore")
  end
end
